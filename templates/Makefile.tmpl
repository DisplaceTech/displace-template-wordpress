# {{.ProjectName}} WordPress Makefile
# Cross-platform support for Linux and macOS

# Load environment variables from .credentials if it exists
ifneq (,$(wildcard .credentials))
    include .credentials
    export
endif

# Default values
PROJECT_NAME ?= {{.ProjectName}}
NAMESPACE ?= {{.Namespace}}
KUBECTL ?= kubectl

# Detect OS for cross-platform compatibility
UNAME_S := $(shell uname -s)
ifeq ($(UNAME_S),Darwin)
    OPEN_CMD = open
else
    OPEN_CMD = xdg-open
endif

# Colors for output
RED=\033[0;31m
GREEN=\033[0;32m
YELLOW=\033[1;33m
BLUE=\033[0;34m
NC=\033[0m # No Color

.DEFAULT_GOAL := help

##@ Help
.PHONY: help
help: ## Display this help
	@awk 'BEGIN {FS = ":.*##"; printf "\n$(BLUE)Usage:$(NC)\n  make $(YELLOW)<target>$(NC)\n"} /^[a-zA-Z_0-9-]+:.*?##/ { printf "  $(YELLOW)%-15s$(NC) %s\n", $$1, $$2 } /^##@/ { printf "\n$(BLUE)%s$(NC)\n", substr($$0, 5) } ' $(MAKEFILE_LIST)

##@ Deployment
.PHONY: deploy
deploy: ## Deploy WordPress to Kubernetes
	@echo "$(BLUE)Deploying WordPress to Kubernetes...$(NC)"
	@if command -v displace >/dev/null 2>&1; then \
		displace project deploy; \
	else \
		echo "$(YELLOW)Displace CLI not found, using kubectl...$(NC)"; \
		$(KUBECTL) apply -f manifests/; \
		$(KUBECTL) apply -f manifests/secrets/ 2>/dev/null || true; \
	fi
	@echo "$(BLUE)Waiting for database to be ready...$(NC)"
	@$(KUBECTL) wait --for=condition=available deployment/$(PROJECT_NAME)-mariadb -n $(NAMESPACE) --timeout=120s
	@echo "$(BLUE)Waiting for WordPress to be ready...$(NC)"
	@$(KUBECTL) wait --for=condition=available deployment/$(PROJECT_NAME)-wordpress -n $(NAMESPACE) --timeout=180s
	@echo ""
	@echo "$(GREEN)Deployment completed!$(NC)"
	@echo ""
	@echo "$(BLUE)Access your site:$(NC)"
	@echo "  $(YELLOW)Local access:$(NC) Run 'make port-forward' then visit http://localhost:8080"
	@echo "  $(YELLOW)Admin panel:$(NC) http://localhost:8080/wp-admin"
	@echo ""
	@echo "$(BLUE)Credentials:$(NC)"
	@echo "  $(YELLOW)Username:$(NC) admin"
	@echo "  $(YELLOW)Password:$(NC) See .credentials file"
	@echo ""
	@echo "$(BLUE)Next steps:$(NC)"
	@echo "  - Run 'make status' to check deployment health"
	@echo "  - Run 'make logs' to view application logs"
	@echo "  - Run 'make backup-db' to backup the database"

.PHONY: destroy
destroy: ## Remove WordPress deployment from Kubernetes
	@echo "$(RED)Destroying WordPress deployment...$(NC)"
	@if command -v displace >/dev/null 2>&1; then \
		displace project destroy; \
	else \
		echo "$(YELLOW)Displace CLI not found, using kubectl...$(NC)"; \
		$(KUBECTL) delete -f manifests/ --ignore-not-found; \
	fi
	@echo "$(GREEN)Deployment removed!$(NC)"

##@ Monitoring
.PHONY: status
status: ## Check deployment status
	@echo "$(BLUE)Checking deployment status...$(NC)"
	@if command -v displace >/dev/null 2>&1; then \
		displace project info; \
	else \
		echo "$(YELLOW)Namespace:$(NC)"; \
		$(KUBECTL) get namespace $(NAMESPACE) 2>/dev/null || echo "$(RED)Namespace not found$(NC)"; \
		echo "\n$(YELLOW)Deployments:$(NC)"; \
		$(KUBECTL) get deployments -n $(NAMESPACE) -l app.kubernetes.io/name=$(PROJECT_NAME) 2>/dev/null || echo "$(RED)No deployments found$(NC)"; \
		echo "\n$(YELLOW)Pods:$(NC)"; \
		$(KUBECTL) get pods -n $(NAMESPACE) -l app.kubernetes.io/name=$(PROJECT_NAME) 2>/dev/null || echo "$(RED)No pods found$(NC)"; \
		echo "\n$(YELLOW)Services:$(NC)"; \
		$(KUBECTL) get services -n $(NAMESPACE) -l app.kubernetes.io/name=$(PROJECT_NAME) 2>/dev/null || echo "$(RED)No services found$(NC)"; \
		echo "\n$(YELLOW)PVCs:$(NC)"; \
		$(KUBECTL) get pvc -n $(NAMESPACE) 2>/dev/null || echo "$(RED)No PVCs found$(NC)"; \
		echo "\n$(YELLOW)Ingress:$(NC)"; \
		$(KUBECTL) get ingress -n $(NAMESPACE) -l app.kubernetes.io/name=$(PROJECT_NAME) 2>/dev/null || echo "$(RED)No ingress found$(NC)"; \
	fi

.PHONY: logs
logs: ## View WordPress application logs
	@echo "$(BLUE)Viewing WordPress logs...$(NC)"
	@$(KUBECTL) logs -n $(NAMESPACE) -l app.kubernetes.io/name=$(PROJECT_NAME),app.kubernetes.io/component=wordpress -f --tail=100

.PHONY: logs-db
logs-db: ## View MariaDB database logs
	@echo "$(BLUE)Viewing MariaDB logs...$(NC)"
	@$(KUBECTL) logs -n $(NAMESPACE) -l app.kubernetes.io/name=$(PROJECT_NAME),app.kubernetes.io/component=database -f --tail=100

.PHONY: events
events: ## View recent events for the namespace
	@echo "$(BLUE)Recent events in namespace $(NAMESPACE):$(NC)"
	@$(KUBECTL) get events -n $(NAMESPACE) --sort-by='.lastTimestamp' | tail -20

##@ Access
.PHONY: shell
shell: ## Access WordPress pod shell
	@echo "$(BLUE)Opening shell in WordPress pod...$(NC)"
	@POD=$$($(KUBECTL) get pod -n $(NAMESPACE) -l app.kubernetes.io/name=$(PROJECT_NAME),app.kubernetes.io/component=wordpress -o jsonpath='{.items[0].metadata.name}'); \
	if [ -n "$$POD" ]; then \
		$(KUBECTL) exec -it -n $(NAMESPACE) $$POD -- /bin/bash; \
	else \
		echo "$(RED)No running WordPress pods found$(NC)"; \
	fi

.PHONY: shell-db
shell-db: ## Access MariaDB pod shell
	@echo "$(BLUE)Opening shell in MariaDB pod...$(NC)"
	@POD=$$($(KUBECTL) get pod -n $(NAMESPACE) -l app.kubernetes.io/name=$(PROJECT_NAME),app.kubernetes.io/component=database -o jsonpath='{.items[0].metadata.name}'); \
	if [ -n "$$POD" ]; then \
		$(KUBECTL) exec -it -n $(NAMESPACE) $$POD -- /bin/bash; \
	else \
		echo "$(RED)No running MariaDB pods found$(NC)"; \
	fi

.PHONY: mysql
mysql: ## Connect to MySQL CLI
	@echo "$(BLUE)Connecting to MySQL...$(NC)"
	@POD=$$($(KUBECTL) get pod -n $(NAMESPACE) -l app.kubernetes.io/name=$(PROJECT_NAME),app.kubernetes.io/component=database -o jsonpath='{.items[0].metadata.name}'); \
	if [ -n "$$POD" ]; then \
		$(KUBECTL) exec -it -n $(NAMESPACE) $$POD -- mysql -u wordpress -p$$DB_PASSWORD wordpress; \
	else \
		echo "$(RED)No running MariaDB pods found$(NC)"; \
	fi

.PHONY: port-forward
port-forward: ## Forward local port 8080 to WordPress service
	@echo "$(BLUE)Port forwarding to WordPress (http://localhost:8080)...$(NC)"
	@echo "$(YELLOW)Press Ctrl+C to stop$(NC)"
	@$(KUBECTL) port-forward -n $(NAMESPACE) service/$(PROJECT_NAME)-wordpress 8080:80

.PHONY: open
open: ## Open WordPress in browser (requires port-forward running)
	@echo "$(BLUE)Opening http://localhost:8080 in browser...$(NC)"
	@$(OPEN_CMD) http://localhost:8080

##@ Database Management
.PHONY: backup-db
backup-db: ## Backup WordPress database to local file
	@echo "$(BLUE)Backing up WordPress database...$(NC)"
	@mkdir -p backups
	@BACKUP_FILE="backups/wordpress-$$(date +%Y%m%d-%H%M%S).sql"; \
	POD=$$($(KUBECTL) get pod -n $(NAMESPACE) -l app.kubernetes.io/name=$(PROJECT_NAME),app.kubernetes.io/component=database -o jsonpath='{.items[0].metadata.name}'); \
	if [ -n "$$POD" ]; then \
		$(KUBECTL) exec -n $(NAMESPACE) $$POD -- mysqldump -u wordpress -p$$DB_PASSWORD wordpress > "$$BACKUP_FILE"; \
		echo "$(GREEN)Database backed up to $$BACKUP_FILE$(NC)"; \
	else \
		echo "$(RED)No running MariaDB pods found$(NC)"; \
	fi

.PHONY: restore-db
restore-db: ## Restore WordPress database from backup file (usage: make restore-db FILE=backups/file.sql)
	@if [ -z "$(FILE)" ]; then \
		echo "$(RED)Usage: make restore-db FILE=backups/wordpress-XXXXXX.sql$(NC)"; \
		exit 1; \
	fi
	@if [ ! -f "$(FILE)" ]; then \
		echo "$(RED)Backup file not found: $(FILE)$(NC)"; \
		exit 1; \
	fi
	@echo "$(YELLOW)WARNING: This will overwrite the current database!$(NC)"
	@echo "$(BLUE)Restoring database from $(FILE)...$(NC)"
	@POD=$$($(KUBECTL) get pod -n $(NAMESPACE) -l app.kubernetes.io/name=$(PROJECT_NAME),app.kubernetes.io/component=database -o jsonpath='{.items[0].metadata.name}'); \
	if [ -n "$$POD" ]; then \
		cat "$(FILE)" | $(KUBECTL) exec -i -n $(NAMESPACE) $$POD -- mysql -u wordpress -p$$DB_PASSWORD wordpress; \
		echo "$(GREEN)Database restored from $(FILE)$(NC)"; \
	else \
		echo "$(RED)No running MariaDB pods found$(NC)"; \
	fi

##@ Content Management
.PHONY: backup-content
backup-content: ## Backup WordPress content (wp-content) to local directory
	@echo "$(BLUE)Backing up WordPress content...$(NC)"
	@mkdir -p backups/content-$$(date +%Y%m%d-%H%M%S)
	@POD=$$($(KUBECTL) get pod -n $(NAMESPACE) -l app.kubernetes.io/name=$(PROJECT_NAME),app.kubernetes.io/component=wordpress -o jsonpath='{.items[0].metadata.name}'); \
	if [ -n "$$POD" ]; then \
		$(KUBECTL) cp $(NAMESPACE)/$$POD:/bitnami/wordpress/wp-content backups/content-$$(date +%Y%m%d-%H%M%S)/ -c wordpress; \
		echo "$(GREEN)Content backed up to backups/content-$$(date +%Y%m%d-%H%M%S)/$(NC)"; \
	else \
		echo "$(RED)No running WordPress pods found$(NC)"; \
	fi

##@ Scaling
.PHONY: scale
scale: ## Scale WordPress replicas (usage: make scale REPLICAS=3)
	@if [ -z "$(REPLICAS)" ]; then \
		echo "$(RED)Usage: make scale REPLICAS=3$(NC)"; \
		exit 1; \
	fi
	@echo "$(BLUE)Scaling WordPress to $(REPLICAS) replicas...$(NC)"
	@$(KUBECTL) scale deployment $(PROJECT_NAME)-wordpress -n $(NAMESPACE) --replicas=$(REPLICAS)
	@echo "$(GREEN)WordPress scaled to $(REPLICAS) replicas$(NC)"

##@ Utilities
.PHONY: validate
validate: ## Validate Kubernetes manifests
	@echo "$(BLUE)Validating manifests...$(NC)"
	@for file in manifests/*.yaml; do \
		echo "$(YELLOW)Validating $$file$(NC)"; \
		$(KUBECTL) apply --dry-run=client -f "$$file" >/dev/null; \
	done
	@echo "$(GREEN)All manifests are valid!$(NC)"

.PHONY: info
info: ## Display project information
	@echo "$(BLUE)Project Information:$(NC)"
	@echo "  $(YELLOW)Project:$(NC) $(PROJECT_NAME)"
	@echo "  $(YELLOW)Namespace:$(NC) $(NAMESPACE)"
	@echo "  $(YELLOW)WordPress:$(NC) docker.io/bitnami/wordpress:6.8.2-debian-12-r4"
	@echo "  $(YELLOW)MariaDB:$(NC) docker.io/bitnami/mariadb:11.5.2-debian-12-r4"
